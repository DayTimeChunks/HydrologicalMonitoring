---
title: "Mass Soils - Composite Weeks Alteck 2016"
author: "PAZ"
date: "November 2016"
output: 
  pdf_document:
    fig_caption: yes
---


```{r, echo=FALSE, message=FALSE, include=FALSE}
Sys.setlocale("LC_ALL", "English")
```

## Purpose

This file merges weekly composite concentrations and isotope data. 

Imports: 

- **SoilCompConc_W1toW15.csv** 
- **SoilCompIsotopes_W1toW15.csv** (old, not used)
- **SoilCompIsotopes_W1toW15ng.csv**

Generates:

- **WeeklySoils_Rng.csv**

## Required R-packages:

```{r, message=FALSE}

library("plyr")
library("dplyr")

```

## Working directory

```{r, message=FALSE}

# setwd("D:/Documents/these_pablo/Alteckendorf2016/R")
# setwd("/Users/DayTightChunks/Documents/PhD/Routput/Alteck/R")
# setwd("D:/Documents/these_pablo/Alteckendorf2016/00_TransparencyFolder")
getwd()

```


## Composite Concentrations & Isotope Data - Alteckendorf 2016

Isotopes selected where cleaned according to the following rules:

a) The isotope shift was not largely beyond (2x) Streitwieser theoretical limits (i.e. > 10)
b) Isotope shift was non-negative
c) Nanograms of carbon > 5.0.

1. Import CSV files 

```{r, message=FALSE}

weeklySoilConc = read.csv2("Data/SoilCompConc_W1toW15.csv", header = TRUE)
weeklySoilConc$Date.ti <- as.POSIXct(strptime(weeklySoilConc$Date.Soil, "%d/%m/%Y %H:%M", tz="EST")) # stopped working
sum(is.na(weeklySoilConc$Date.ti))
# View(weeklySoilConc)
weeklySoilConc <- weeklySoilConc[,c("Filename",
                                    "Transect",
                                    "Wnum",
                                    "Date.Soil",
                                    "Date.ti",
                                    "Conc.mug.g.dry.soil",
                                    "Conc.ComSoil.SD")]

colnames(weeklySoilConc)[colnames(weeklySoilConc) == "Filename"] <- "ID"
print("Soil Composites- Concentrations")
str(weeklySoilConc)

# weeklySoilIso = read.csv2("Data/SoilCompIsotopes_W1toW15.csv", header = TRUE) # JESIUM data (before nangoram revision)
weeklySoilIso  = read.csv2("Data/SoilCompIsotopes_W1toW15ng.csv", header = TRUE, dec = ".")
if (length(weeklySoilIso) == 1){
  weeklySoilIso = read.csv("Data/SoilCompIsotopes_W1toW15ng.csv", header = T)
}
head(weeklySoilIso)


colnames(weeklySoilIso)[colnames(weeklySoilIso) == "DD13...31.21."] <- "DD13"
colnames(weeklySoilIso)[colnames(weeklySoilIso) == "ng..C."] <- "ngC"
colnames(weeklySoilIso)[colnames(weeklySoilIso) == "Filename"] <- "ID"

weeklySoilIso <- weeklySoilIso[, c("ID",
                                   "Repl",
                                   "d.13C.12C",
                                   "DD13", 
                                   "ngC")]

weeklySoilIso <- subset(weeklySoilIso, DD13 > 0 & DD13 < 10) # & ngC >= 5)


isoCompSummary = ddply(weeklySoilIso, c("ID"), summarise,
                         N_compsoil    = length(d.13C.12C),
                         comp.d13C = mean(d.13C.12C),
                         comp.d13C.SD = sd(d.13C.12C),
                         comp.d13C.SE = comp.d13C.SD / sqrt(N_compsoil),
                         N_ngC = length(ngC),
                         ngC.mean = mean(ngC),
                         ngC.SD = sd(ngC),
                         ngC.SE = ngC.SD/sqrt(N_ngC))


print("Soil Composites - Isotopes All")
str(weeklySoilIso)

print("Soil Composites - Isotopes Ave and St.Dev.")
str(isoCompSummary)
```

2. Merge lab concentrations and isotopes

```{r}
comp.CoIs = merge(weeklySoilConc, isoCompSummary, by = "ID", all = T)
comp.CoIs$Wnum = as.numeric(comp.CoIs$Wnum)
comp.CoIs <- comp.CoIs[order(comp.CoIs$Wnum),]

comp.CoIs$comp.IMP.d13C <- comp.CoIs$comp.d13C
comp.CoIs$comp.IMP.d13C[is.na(comp.CoIs$comp.d13C)] <- ave(comp.CoIs$comp.d13C,
                                                           comp.CoIs$Wnum,
                                                           FUN= function(x) mean(x, na.rm = T))[is.na(comp.CoIs$comp.d13C)] 


comp.CoIs$comp.d13C <- ifelse(is.na(comp.CoIs$comp.d13C), comp.CoIs$comp.IMP.d13C, comp.CoIs$comp.d13C) 

print("Merged Soil Concentrations and Isotopes")
str(comp.CoIs)  
```


3. Compute Degradation Extent and Delta-delta 

```{r}

# Pure and cuve isotope average
d13Co = -31.2144

# Lab enrichment:
# Alteck
epsilon_max = -1.5 # +/- 0.3 (@ 20C, 20% vwc)
epsilon_min = -2.0 # +/- 0.2 (@ 20C, 40% vwc)

mean(c(epsilon_max, epsilon_min))
sd(c(epsilon_max, epsilon_min))

epsilon_mean = -1.75

# Vine
# (@ 20C, 20% vwc) -0.8 +/- 0.1
# (@ 30C, 20% vwc) -1.4 +/- 0.2 
# (@ 20C, 40% vwc) -1.7 +/- 0.2
# Average

# Remaining fraction
comp.CoIs$DD13C.comp <- (comp.CoIs$comp.d13C - (d13Co))

# Max epsilon (20C, 20%) 
comp.CoIs$f.max.comp <-
  ((10^(-3)*comp.CoIs$comp.d13C + 1)/(10^(-3)*d13Co + 1))^(1000/(epsilon_max))

comp.CoIs$B.max.comp <-
  (1 - comp.CoIs$f.max.comp)*100 

# Min epsilon (20C, 40%) 
comp.CoIs$f.min.comp <-
  ((10^(-3)*comp.CoIs$comp.d13C + 1)/(10^(-3)*d13Co + 1))^(1000/(epsilon_min))

comp.CoIs$B.min.comp <-
  (1 - comp.CoIs$f.min.comp)*100

# Mean epsilon (# Alteck)
comp.CoIs$f.mean.comp <- 
  ((10^(-3)*comp.CoIs$comp.d13C + 1)/(10^(-3)*d13Co + 1))^(1000/(epsilon_mean))

comp.CoIs$B.mean.comp <-
  (1 - comp.CoIs$f.mean.comp)*100



```

3. Compute Soil S-metolachlor Mass at time $t$ across space  

For non-measured plots, the soil concentration and isotope measured at the neareast transect is assumed. The total area for each transect at the end of the season is shown below. Corn fields in the catchment were known to have received S-metolachlor applications only during the last week of May, 2017. Given that two of these plots were not included within the transects, their area were not accounted for but until after the known application dates for corn plots. 

![Transect Areas $[Ha]$ (North: 14.995; Talweg: 8.774; South: 12.668)](Images/TransectAreas.png)

The total pesticide mass for each transect at time $t$ is then given by:

$$
M(t)_{Ta} = C(t)_{T} \cdot \rho \cdot A_T \cdot D \cdot   
$$



```{r, echo=T}

# S-metolachlor Mass [g]
# Conc. [ug/g dry soil] * [g/10^6 ug] * density [g/m3] * depth [m]* A [m2] 
# Soil bulk density: 2200 or 0.99? -> Leaching experiments: 0.99 [g/cm3]
rho = 0.99*10^6 # soil density [g/m3]
depth = 0.005 # [m]

# Transect Areas pre-corn applications
Area_Na = 13.92663*10^4 # [m2]

# Corrections (old values):
#Area_Ta = 6.55813*10^4  # [m2] # South Burger's as Talweg
#Area_Sa = 11.05376*10^4 # [m2] # South Burger's as Talweg
Area_Ta = 4.37134*10^4  # [m2]
Area_Sa = 13.3175*10^4 # [m2] # South Burger's as South

# Transect Areas post Corn applications (not on transect)
Area_Nb = 14.9949*10^4 # [m2] 

# Corrections (old values): 
#Area_Tb = 6.55813*10^4  # [m2] # South Burger's as Talweg
#Area_Sb = 11.65202*10^4 # [m2] # South Burger's as Talweg
Area_Tb = 4.37134*10^4  # [m2]
Area_Sb = 13.91767*10^4 # [m2] # South Burger's as South




# Assign new column for S-metolachlor mass in grams
comp.CoIs$MassSoil.g <- NA

# Areas with S-metolachlor before week 9
comp.CoIs$MassSoil.g <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum < 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Na,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum < 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Ta, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum < 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Sa, comp.CoIs$MassSoil.g)))

# Areas with S-metolachlor after week 9
comp.CoIs$MassSoil.g <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum >= 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Nb,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum >= 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Tb, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum >= 6), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Sb, comp.CoIs$MassSoil.g)))

# Areas as variables (for later computation of bulk catchment mass)
comp.CoIs$Area.N <-
  ifelse((comp.CoIs$Wnum < 6), Area_Na, Area_Nb)
         
comp.CoIs$Area.T <-
  ifelse((comp.CoIs$Wnum < 6), Area_Ta, Area_Tb)

comp.CoIs$Area.S <-
  ifelse((comp.CoIs$Wnum < 6), Area_Sa, Area_Sb)
  

print("S-meto mass per transect at time-t")
str(comp.CoIs)
tail(comp.CoIs)

write.csv2(comp.CoIs, 'Data/WeeklySoils_Rng.csv', row.names = F)
```
