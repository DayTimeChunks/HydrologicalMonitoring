---
title: "Mass Soils - Composite Weeks Alteck 2016"
author: "PAZ"
date: "November 2016"
output: 
  pdf_document:
    fig_caption: yes
---


```{r, echo=FALSE, message=FALSE, include=FALSE}
Sys.setlocale("LC_ALL", "English")
```

## Purpose

This file merges weekly composite concentrations and isotope data. 

Imports: 

- **SoilCompConc_W1toW15.csv** 
- **SoilCompIsotopes_W1toW15.csv** (old, not used)
- **SoilCompIsotopes_W1toW15ng.csv**

Generates:

- **WeeklySoils_Rng.csv**

## Required R-packages:

```{r, message=FALSE}

library("plyr")
library("dplyr")

```

## Working directory

```{r, message=FALSE}

# setwd("D:/Documents/these_pablo/Alteckendorf2016/R")
# setwd("/Users/DayTightChunks/Documents/PhD/Routput/Alteck/R")
# setwd("D:/Documents/these_pablo/Alteckendorf2016/00_TransparencyFolder")
getwd()

```

## Lab Parameters

```{r}
# Pure and cuve isotope average
d13Co = -32.253

```

## Field Assumptions

```{r}
# S-metolachlor Mass [g]
# Conc. [ug/g dry soil] * [g/10^6 ug] * density [g/m3] * depth [m]* A [m2] 
# Soil bulk density: 2200 or 0.99? -> Leaching experiments: 0.99 [g/cm3]
rho = 0.99*10^6 # soil density [g/m3]
depth = 0.01 # [m]

# Transect Areas pre-corn applications
Area_Na = 13.92663*10^4 # [m2]

# Assumptions on Non-measured plots - Transect assignment:
#Area_Ta = 6.55813*10^4  # [m2] # South Burger's as Talweg
#Area_Sa = 11.05376*10^4 # [m2] # South Burger's as Talweg
Area_Ta = 4.37134*10^4  # [m2]
Area_Sa = 13.3175*10^4 # [m2] # South Burger's as South

# Transect Areas post Corn applications (not on transect)
Area_Nb = 14.9949*10^4 # [m2] 

# Assumptions on Non-measured plots - Transect assignment:
#Area_Tb = 6.55813*10^4  # [m2] # South Burger's as Talweg
#Area_Sb = 11.65202*10^4 # [m2] # South Burger's as Talweg
Area_Tb = 4.37134*10^4  # [m2]
Area_Sb = 13.91767*10^4 # [m2] # South Burger's as South

Area_tot <- Area_Nb + Area_Tb + Area_Sb
Area_tot 

# Areas touching each transect (respective to)needed for Rayleigh initial concentrations) 
#Area_Nt <- 101721.702 # [m2] 
#Area_Tt <- 39247.330
#Area_St <- 94205.501
```


## Composite Concentrations & Isotope Data - Alteckendorf 2016

1. Import CSV files 

```{r, message=FALSE}

#weeklySoilConc = read.csv2("Data/SoilCompConc_W1toW15.csv", header = TRUE)
# Date format stopped working in CSV
# Convert in CSV via  "=TEXT(CELL.ID, "dd/mm/yyyy hh:mm")" based on xls-file date

weeklySoilConc = read.csv2("Data/SoilCompConc_W1toW15.csv", header = TRUE, dec = ".")
if (length(weeklySoilConc) == 1){
  weeklySoilConc = read.csv("Data/SoilCompConc_W1toW15.csv", header = TRUE)
}
head(weeklySoilConc)

weeklySoilConc$Date.ti <- as.POSIXct(strptime(weeklySoilConc$Date.Soil, "%d/%m/%Y %H:%M", tz="EST")) 
sum(is.na(weeklySoilConc$Date.ti))
# View(weeklySoilConc)
weeklySoilConc <- weeklySoilConc[,c("Filename",
                                    "Transect",
                                    "Wnum",
                                    "Date.Soil",
                                    "Date.ti",
                                    "Conc.mug.g.dry.soil",
                                    "Conc.ComSoil.SD")]

colnames(weeklySoilConc)[colnames(weeklySoilConc) == "Filename"] <- "ID"
print("Soil Composites- Concentrations")
str(weeklySoilConc)

# JESIUM data (before nangoram revision)
# weeklySoilIso = read.csv2("Data/SoilCompIsotopes_W1toW15.csv", header = TRUE) 

# After nanogram revision
weeklySoilIso  = read.csv2("Data/SoilCompIsotopes_W1toW15ng.csv", header = TRUE, dec = ".")
if (length(weeklySoilIso) == 1){
  weeklySoilIso = read.csv("Data/SoilCompIsotopes_W1toW15ng.csv", header = T)
}
head(weeklySoilIso)
colnames(weeklySoilIso)
weeklySoilIso <- weeklySoilIso[complete.cases(weeklySoilIso[, "d.13C.12C"]), ]
colnames(weeklySoilIso)[colnames(weeklySoilIso) == "DD13.32.253."] <- "DD13"
weeklySoilIso$DD13 <- weeklySoilIso$d.13C.12C - -32.253
colnames(weeklySoilIso)[colnames(weeklySoilIso) == "ng..C."] <- "ngC"
colnames(weeklySoilIso)[colnames(weeklySoilIso) == "Filename"] <- "ID"

weeklySoilIso <- weeklySoilIso[, c("ID",
                                   # "Repl",
                                   "d.13C.12C",
                                   "DD13", 
                                   "ngC")]

isoCompSummary = ddply(weeklySoilIso, c("ID"), summarise,
                         N_compsoil    = length(d.13C.12C),
                         comp.d13C = mean(d.13C.12C),
                         comp.d13C.SD = sd(d.13C.12C),
                         # comp.d13C.SE = comp.d13C.SD / sqrt(N_compsoil),
                         N_ngC = length(ngC),
                         ngC.mean = mean(ngC),
                         ngC.SD = sd(ngC) #,
                         # ngC.SE = ngC.SD/sqrt(N_ngC)
                       )

isoCompSummary$prctError <- (isoCompSummary$comp.d13C.SD/isoCompSummary$comp.d13C)*-100
mean(!is.na(isoCompSummary$prctError))

sum(isoCompSummary$N_ngC == 2)/(sum(isoCompSummary$N_ngC == 2) + sum(isoCompSummary$N_ngC > 2))


print("Soil Composites - Isotopes All")
str(weeklySoilIso)

print("Soil Composites - Isotopes Ave and St.Dev.")
str(isoCompSummary)
```

2. Merge lab concentrations and isotopes

```{r}
comp.CoIs = merge(weeklySoilConc, isoCompSummary, by = "ID", all = T)
comp.CoIs$Wnum = as.numeric(comp.CoIs$Wnum)
comp.CoIs <- comp.CoIs[order(comp.CoIs$Wnum),]

comp.CoIs$comp.IMP.d13C <- comp.CoIs$comp.d13C
comp.CoIs$comp.IMP.d13C[is.na(comp.CoIs$comp.d13C)] <- ave(comp.CoIs$comp.d13C,
                                                           comp.CoIs$Wnum,
                                                           FUN= function(x) mean(x, na.rm = T))[is.na(comp.CoIs$comp.d13C)] 


# comp.CoIs$comp.d13C <- ifelse(is.na(comp.CoIs$comp.d13C), comp.CoIs$comp.IMP.d13C, comp.CoIs$comp.d13C) 

comp.CoIs$DD13C.comp <- (comp.CoIs$comp.d13C - (d13Co))

print("Merged Soil Concentrations and Isotopes")
str(comp.CoIs)  
```


3. Compute Soil S-metolachlor Mass at time $t$ across space  

For non-measured plots, the soil concentration and isotope measured at the neareast transect is assumed. The total area for each transect at the end of the season is shown below. Corn fields in the catchment were known to have received S-metolachlor applications only during the last week of May, 2017. Given that two of these plots were not included within the transects, their area was not accounted for but until after the known application dates for corn plots. 

![Transect Areas $[Ha]$ (North: 14.995; Talweg: 4.371; South: 13.918)](Images/TransectAreas.png)

```{r}
# Check values:
Area_Nb/10000 
Area_Tb/10000 
Area_Sb/10000

```


The total pesticide mass for each transect at time $t$ is then given by:

$$
M(t)_{Ta} = C(t)_{T} \cdot \rho \cdot A_T \cdot D  
$$



```{r, echo=T}

# S-metolachlor Mass [g]
# Conc. [ug/g dry soil] * [g/10^6 ug] * density [g/m3] * depth [m]* A [m2] 
# Soil bulk density: 2200 or 0.99? -> Leaching experiments: 0.99 [g/cm3]
rho # soil density [g/m3]
depth # [m]

# Transect Areas pre-corn applications
Area_Na # [m2]
Area_Ta  # [m2]
Area_Sa # [m2]

# Transect Areas post Corn applications (not on transect)
Area_Nb # [m2] 
Area_Tb # [m2]
Area_Sb # [m2]

# Assign new column for S-metolachlor mass in grams
comp.CoIs$MassSoil.g <- NA
comp.CoIs$MassSoil.g.SD <- NA

# Areas with S-metolachlor before week 9
comp.CoIs$MassSoil.g <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Na,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Ta, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Sa, comp.CoIs$MassSoil.g)))

comp.CoIs$MassSoil.g.SD <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Na,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Ta, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum < 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Sa, comp.CoIs$MassSoil.g.SD)))

# Areas with S-metolachlor after week 9
comp.CoIs$MassSoil.g <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Nb,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Tb, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.mug.g.dry.soil*10^-6*rho*depth*Area_Sb, comp.CoIs$MassSoil.g)))

comp.CoIs$MassSoil.g.SD <- 
  ifelse((comp.CoIs$Transect == "N" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Nb,
  ifelse((comp.CoIs$Transect == "T" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Tb, 
  ifelse((comp.CoIs$Transect == "S" & comp.CoIs$Wnum >= 9), 
         comp.CoIs$Conc.ComSoil.SD*10^-6*rho*depth*Area_Sb, comp.CoIs$MassSoil.g.SD)))

# Areas as variables (for later computation of bulk catchment mass)
comp.CoIs$Area.N <-
  ifelse((comp.CoIs$Wnum < 9), Area_Na, Area_Nb)
         
comp.CoIs$Area.T <-
  ifelse((comp.CoIs$Wnum < 9), Area_Ta, Area_Tb)

comp.CoIs$Area.S <-
  ifelse((comp.CoIs$Wnum < 9), Area_Sa, Area_Sb)
  
# Needed to compute Transect res
#comp.CoIs$Area_Nt <- Area_Nt  # [m2] 
#comp.CoIs$Area_Tt <- Area_Tt 
#comp.CoIs$Area_St <- Area_St

names(comp.CoIs)
print("S-meto mass per transect at time-t")
str(comp.CoIs)
tail(comp.CoIs)

write.csv2(comp.CoIs, 'Data/WeeklySoils_Rng.csv', row.names = F)
```
